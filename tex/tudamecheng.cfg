

\RequirePackage{pgf}

\cs_new:Nn \TUDa_mecheng_arrow:N {
	\begin{pgfpicture}
		\pgfsetcolor{TUDa-Arrow}
		\pgfsetrectcap
		\str_if_eq:VnTF \c__TUDa_base_str {leaflet}
			{\pgfsetlinewidth{2\g_TUDa_titlerule_dim}}
			{\pgfsetlinewidth{2\c_TUDa_smallrule_dim}}
		\pgfpathmoveto{\pgfpointorigin}
		\pgfpathlineto{\pgfpointpolar{174}{.05#1}}
		\pgfpathlineto{\pgfpointpolar{186}{.05#1}}
		\pgfpathclose
		\pgfusepath{fill}
		\pgfpathmoveto{\pgfpoint{-.04#1}{0}}
		\pgfpathlineto{\pgfpoint{-#1}{0}}
		\pgfusepath{stroke}
	\end{pgfpicture}
}
\NewDocumentCommand{\MechEngArrow}{sm}{
	\IfBooleanT{#1}{\begingroup\colorlet{TUDa-Arrow}{.}}
	\dim_set:Nn \l_tmpa_dim {#2}\TUDa_mecheng_arrow:N \l_tmpa_dim
	\IfBooleanT{#1}{\endgroup}
}

\box_new:N \g_TUDa_footline_box %TODO cleanup
\hbox_gset:Nn \g_TUDa_footline_box {\MechEngArrow{\textwidth}}


\RenewDocumentCommand{\TUDa@makefootrule}{som}{
	\keys_set:nn {TUDa/rules} {
		width= \textwidth
	}
	\IfNoValueF {#2} {\keys_set:nn {TUDa/rules}{#2}}
	\IfBooleanF {#1} {\box_new:c {#3_box}}
	\IfBooleanTF {#1} \use_none:n \hbox_gset:cn {#3_box} {
		\raisebox{-\height}{\MechEngArrow{\l_TUDa_headrule_width_dim}}
	}
	\IfBooleanF{#1} {\cs_new:cpn {#3} {\box_use:c {#3_box}}}
}


\str_if_eq:VnT \c__TUDa_base_str {pub} {

\ModifyLayer[
contents={
	\color{\l_TUDa_headrule_color_tl}
	\smash{\rule{\layerwidth}{.5\c_TUDa_largerule_dim}}
}
]{title.TUDa.rule}

\ModifyLayer[
contents={
	\dim_compare:nF {\box_wd:N \g_TUDa_footline_box=\layerwidth} {
		\hbox_gset:Nn \g_TUDa_footline_box {\MechEngArrow{\layerwidth}}
	}
	\fp_set:Nn \l_tmpa_fp {\dim_to_decimal_in_unit:nn {.5\box_ht:N \g_TUDa_footline_box} {\unitlength}}
	\def\height{\dim_eval:n {\layerheight-.5\box_ht:N \g_TUDa_footline_box}}
	\tl_if_empty:NTF \g_TUDa_titleimage_code_tl
	{
		\bool_if:NT \g_TUDa_colorback_bool {\put(0,\fp_use:N \l_tmpa_fp){\color{identbarcolor}\rule{\layerwidth}{\height}}}
	}{
		\put(0,\fp_use:N \l_tmpa_fp){
			\color{identbarcolor}
			\parbox[t]{\textwidth}{
				\let\width\layerwidth
				\leavevmode\ignorespaces
				\g_TUDa_titleimage_code_tl
			}
		}
	}
	\bool_if:NF \g_TUDa_logo@inhead_bool {
		\put(\dim_to_decimal_in_unit:nn {\layerwidth-2.2\c_TUDa_logoheight_dim
		} {\unitlength},
		\dim_to_decimal_in_unit:nn {\layerheight-\box_ht:N \g_TUDa_title_info_box - .5\c_TUDa_logoheight_dim} {\unitlength}){
			\rlap{\box_use:N \g_TUDa_title_info_box}
		}
	}
	\put(0,0){\parbox[t]{\layerwidth}{%
			\MechEngArrow{\linewidth}\\[\c_TUDa_rulesep_dim]
			\usekomafont{pagefoot}\includegraphics[width=\c_TUDa_logoheight_dim]{\g_TUDa_departmentlogo_tl}
	}}
}
]{title.TUDa.image}


\renewcommand*{\sectionformat}{\color{TUDa-Primary2}\thesection\autodot\enskip}
\if@titlepage
	\titlehead{\rule{0pt}{\c_TUDa_logoheight_dim}}
\fi

\addtokomafont{footsepline}{\color{accentcolor}}

}


\str_case:VnT  \c__TUDa_base_str {
	{exercise} {}
	{pub} {}	
}{
\newpairofpagestyles[TUDa.\c__TUDa_base_str]{TUDa.mecheng}{
	\KOMAoptions{plainfootsepline,footsepline=5pt}
	
	\ModifyLayer[
	clone=TUDa.\c__TUDa_base_str.head.above.line
	]{TUDa.mecheng.head.above.line}
	\ModifyLayer[
	clone=plain.TUDa.\c__TUDa_base_str.head.above.line
	]{plain.TUDa.mecheng.head.above.line}

	
	\ModifyLayer[
	contents={
		\dim_compare:nF {\box_wd:N \g_TUDa_footline_box=\layerwidth} {
			\hbox_gset:Nn \g_TUDa_footline_box {\MechEngArrow{\layerwidth}}
		}
		\smash{\box_use:N \g_TUDa_footline_box}
	}
	]{TUDa.mecheng.foot.above.line}
	
	\ModifyLayer[
	contents={
		\dim_compare:nF {\box_wd:N \g_TUDa_footline_box=\layerwidth} {
			\hbox_gset:Nn \g_TUDa_footline_box {\MechEngArrow{\layerwidth}}
		}
		\smash{\box_use:N \g_TUDa_footline_box}
	}
	]{plain.TUDa.mecheng.foot.above.line}
	
	
	\clearpairofpagestyles
	\cfoot[\pagemark]{\pagemark}
	
	\tl_if_empty:NF \g_TUDa_departmentlogo_tl {
		\lefoot[{\raisebox{-\height}{\includegraphics[width=\c_TUDa_logoheight_dim]{\g_TUDa_departmentlogo_tl}}}]{\raisebox{-\height}{\includegraphics[width=\c_TUDa_logoheight_dim]{\g_TUDa_departmentlogo_tl}}}
		\lofoot[{\raisebox{-\height}{\includegraphics[width=\c_TUDa_logoheight_dim]{\g_TUDa_departmentlogo_tl}}}]{\raisebox{-\height}{\includegraphics[width=\c_TUDa_logoheight_dim]{\g_TUDa_departmentlogo_tl}}}
	}
}
\DeclarePageStyleAlias{TUDa}{TUDa.mecheng}
\DeclarePageStyleAlias{plain.TUDa}{plain.TUDa.mecheng}
\pagestyle{TUDa}
\renewcommand*{\titlepagestyle}{plain.TUDa}


}


\str_if_eq:VnT \c__TUDa_base_str {sciposter} {

	\cs_set:Nn \__TUDa_typeset_footer: {
		\coordinate(lastpos) at (bottomright);
		\tl_if_empty:NF \g_TUDa_poster_qrcode_tl
		{
			\node[anchor=south~east, inner~sep=\z@] (qrcode)at (lastpos)
			{
				\exp_args:NnV \use:n {\qrcode[height=\dim_use:N \g_TUDa_footheight_dim]}\g_TUDa_poster_qrcode_tl
			};
			\coordinate (lastpos) at (qrcode.south~west);
		}
		\box_if_empty:NF \g_TUDa_footergraphics_box {
			\node[anchor=south~east, inner~sep=\z@] at (lastpos) {
				\accentfont
				\box_use:N \g_TUDa_footergraphics_box
			};
		}
		\node[anchor=south~west,inner~sep=\z@] (footerarrow) at ([yshift=\g_TUDa_footheight_dim]bottomleft) {\MechEngArrow{\contentwidth}};
		\node[anchor=north~west,inner~sep=\z@] (departmentlogo) at ([yshift=\g_TUDa_footheight_dim]bottomleft)
			{\includegraphics[width=\dimexpr2\linewidth/7]{\g_TUDa_departmentlogo_tl}};
		\node[anchor=south~west,inner~sep=\z@] (infofooter) at (footerarrow.north~west) {
				\parbox{\contentwidth}{
					\accentfont\small\g_TUDa_poster_foot_tl
					\par\medskip
					\let\footnotetext\TUDa@title@footnote
					\g_TUDa_thanks_tl}
		};
	}

}

\str_if_eq:VnT \c__TUDa_base_str {poster} {
	
		\ModifyLayer[
		clone=TUDa.poster.qrcode,
		align=bl,
		hoffset=\g_TUDa_margin_dim,
		width=\paperwidth-2\g_TUDa_margin_dim,
		height=\g_TUDa_footheight_dim,
		contents={
			\usekomafont{pagefoot}
			\bool_if:NTF \g_TUDa_poster_foot_bool {
			\put(0,\LenToUnit{\g_TUDa_qrcode_dim+\g_TUDa_footheight_dim}){\rlap{\rule{\dimexpr\paperwidth-2\g_TUDa_margin_dim}{.5\c_TUDa_smallrule_dim}}}
			\put(0,\LenToUnit{\g_TUDa_qrcode_dim+.5\g_TUDa_footheight_dim}) {
				\parbox[c][\g_TUDa_footheight_dim][c]{\layerwidth}{\strut\g_TUDa_poster_foot_tl\strut}}
			\put(0,\LenToUnit{1.2\g_TUDa_qrcode_dim}){\rlap{\TUDa@makefootrule*[width=\dimexpr\paperwidth-2\g_TUDa_margin_dim, color=identbarcolor]{TUDa@footrule}}}
			\putLL{
				\includegraphics[width=\dimexpr2\linewidth/7]{\g_TUDa_departmentlogo_tl}
			}
			}{
					\put(0,\LenToUnit{1.2\g_TUDa_qrcode_dim}){\rlap{\TUDa@makefootrule*[width=\dimexpr\paperwidth-2\g_TUDa_margin_dim, color=identbarcolor]{TUDa@footrule}}}
			\putLL{
				\includegraphics[width=\dimexpr2\linewidth/7]{\g_TUDa_departmentlogo_tl}
			}
			}
		}
		]{TUDa.poster.footer}

	\dim_set:Nn \g_TUDa_footheight_dim {\dim_max:nn {2\g_TUDa_footheight_dim} {1.5\baselineskip}}

	\geometry{bottom=\dim_eval:n {\g_TUDa_footheight_dim+\footskip+\g_TUDa_margin_dim}}
	
}

\str_if_eq:VnT \c__TUDa_base_str {letter} {

	\setkomavar{nextfoot}{
		\raisebox{-\height}[0pt][0pt]{
		\parbox{\useplength{firstfootwidth}}{
			\usekomafont{pagefoot}
			\includegraphics[width=1.4\c_TUDa_logoheight_dim]{\g_TUDa_departmentlogo_tl}\\
			\MechEngArrow{\l_TUDa_headrule_width_dim}
		}
		}
	}

	\setkomavar{nexthead}{}

	\newpairofpagestyles[TUDaLetter]{TUDaLetter.mecheng}{
		\KOMAoptions{footsepline=false,pagenumber=topright}
		\clearpairofpagestyles
		\lehead{\usekomavar{nexthead}}%
		\lohead{\usekomavar{nexthead}}%
		\lefoot{\usekomavar{nextfoot}}%
		\lofoot{\usekomavar{nextfoot}}%
		\rehead[\pagemark]{\pagemark}
		\rohead[\pagemark]{\pagemark}
	}

	\DeclarePageStyleByLayers{TUDaLetter.mecheng.first}{TUDaLetter.mecheng.foot.even,TUDaLetter.mecheng.foot.odd,TUDaLetter.mecheng.foot.oneside,TUDaLetter.mecheng.foot.above.line}
	\DeclarePageStyleAlias{letter.first}{TUDaLetter.mecheng.first}

	\def\letterpagestyle{TUDaLetter.mecheng}
	\geometry{bottom=\dimexpr\c_TuDa_BottomMargin_dim+10mm}

}

\str_if_eq:VnT \c__TUDa_base_str {leaflet} {
	\ModifyLayer[
		contents={\raisebox{-\height}[0pt][0pt]{\parbox{\layerwidth}{
				\leavevmode\box_use:N \TUDa_footrule_box\\[\c_TUDa_rulesep_dim]
				\includegraphics[width=\c_TUDa_logoheight_dim]{\g_TUDa_departmentlogo_tl}
		}}}
	]{TUDa.flyer.footline}
}

\endinput