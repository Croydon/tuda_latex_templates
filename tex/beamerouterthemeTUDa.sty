\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{beamerouterthemeTUDa}
 [\filedate\space\fileversion]

\RequirePackage{l3keys2e}

\newlength{\TUDa@beamer@extraindent}

\ExplSyntaxOn
\cs_if_exist:NF \g_TUDa_colorframetitle_bool {\bool_new:N \g_TUDa_colorframetitle_bool}

\keys_define:nn {TUDa/beamer/outer} {
	logo .bool_gset:N = \g_TUDa_headlinelogo_bool,
	logo .default:n =true,
	logo .initial:n =true,
	logofile .tl_gset:N = \g_TUDa_logofile_tl,
	logofile .initial:n = tuda_logo,
    colorframetitle .code:n = 
	    \use:c {bool_gset_#1:N} \g_TUDa_colorframetitle_bool
	    \bool_if:NTF \g_TUDa_colorframetitle_bool
		    {\setlength{\TUDa@beamer@extraindent}{\TUDa@beamer@logosep}}
	    	{\setlength{\TUDa@beamer@extraindent}{\z@}}
		\cs_if_exist_use:N  \__TUDa_setup_frametitle_color:  
	,
    colorframetitle .default:n = true,
    centerframetitle .bool_gset:N = \g_TUDa_centerframetitle_bool,
    centerframetitle .initial:n = false,
    centerframetitle .default:n = true,
	framebgcolor .choice:,
	framebgcolor / reset .code:n = 
		\__TUDa_reset_framebgcolor:
	,
   	framebgcolor / unknown .code:n = {
   		\__TUDa_set_framebgcolor:n {#1}
	},
    singleframebgcolor .code:n = {
    	\cs_gset_eq:Nc \__TUDa_save_background_canvas: {beamer@thcbg@normal~text}
    	\keys_set:nn {TUDa/beamer/outer} {
    		framebgcolor = #1
    	}
    },
	headsepline .bool_gset:N = \g_TUDa_headsepline_bool,
	headsepline .initial:n = true,
	headsepline .default:n = true,
}

\define@key{beamerframe}{bgcolor}{
	\keys_set:nn {TUDa/beamer/outer} {
		singleframebgcolor=#1
	}
}

\cs_new:Nn \__TUDa_reset_framebgcolor: {
	\cs_gset_eq:cN {beamer@thcbg@normal~text} \__TUDa_save_background_canvas: 
	\cs_undefine:N \__TUDa_save_background_canvas:
}

\cs_new:Nn \__TUDa_set_framebgcolor:n {
		\cs_if_exist:cTF {\string\color@#1}
		{\setbeamercolor{normal~text}{bg=#1}}
		{\setbeamercolor{normal~text}{bg=TUDa-#1}}
}

\BeforeBeginEnvironment{frame}{
	\cs_if_exist:NT \__TUDa_save_background_canvas: {
	\__TUDa_reset_framebgcolor:
	}
}

\ProcessKeysOptions{TUDa/beamer/outer}


\mode<presentation>


\RequirePackage{graphicx}
\RequirePackage[paper=slide]{tudarules}

\newlength{\TUDa@beamer@sep}
\setlength{\TUDa@beamer@sep}{1em}
\newlength{\TUDa@beamer@logosep}
\setlength{\TUDa@beamer@logosep}{2mm}

\ExplSyntaxOn
\bool_if:NT \g_TUDa_colorframetitle_bool
	{\setlength{\TUDa@beamer@extraindent}{\TUDa@beamer@logosep}}

\setbeamersize{
  text~margin~left= \dimexpr\TUDa@beamer@sep+\TUDa@beamer@extraindent\relax,
  text~margin~right=\dimexpr\TUDa@beamer@sep+\TUDa@beamer@extraindent\relax,
}

\def\TUDa@beamer@linewidth{\dimexpr\paperwidth
	-\beamer@leftmargin-\beamer@rightmargin
}

%Logo

\newsavebox{\TUDa@logobox}
\sbox{\TUDa@logobox}{%
	\makebox[2.2\c_TUDa_logoheight_dim][l]{\includegraphics[height=\c_TUDa_logoheight_dim]{\g_TUDa_logofile_tl}}%
}

\TUDa@makeheadrule[color=identbarcolor,width=\paperwidth-2\TUDa@beamer@sep]{TUDa@beamer@headrule}
\TUDa@makefootrule[width=\paperwidth-2\TUDa@beamer@sep]{TUDa@beamer@rule}

\newlength{\TUDa@beamer@headheight}
\setlength{\TUDa@beamer@headheight}{
\dim_eval:n {
	\ht\TUDa@logobox+
	\dp\TUDa@logobox +
	2\TUDa@beamer@logosep+
	\box_ht:N \TUDa@beamer@rule_box +
	\box_dp:N \TUDa@beamer@rule_box
}}


\ExplSyntaxOff


\def\tudrule{\TUDa@beamer@rule}


\newcommand\insertsmalllogo{\setbeamertemplate{logo}[small]\usebeamertemplate{logo}}


\defbeamertemplate*{sidebar left}{TUD theme}{}
\defbeamertemplate*{sidebar right}{TUD theme}{}


\ExplSyntaxOn

\bool_if_exist:NF \l_TUDa_tmpa_bool {\bool_new:N \l_TUDa_tmpa_bool}

\defbeamertemplate*{footline}{TUDa theme}
{
	\begin{beamercolorbox}[leftskip=\TUDa@beamer@sep,rightskip=\TUDa@beamer@sep,
		ht=\csname c_TUDa_smallrule_dim\endcsname,dp=1mm]{footline}
	\TUDa@beamer@rule
	\end{beamercolorbox}
  	\begin{beamercolorbox}[
  	leftskip=\TUDa@beamer@sep,
  	rightskip=\TUDa@beamer@sep, ht=2.75mm,dp=2.75mm]{footline}
	\usebeamerfont{author~ in~ head/foot}%
	\bool_set_false:N \l_TUDa_tmpa_bool
	\clist_map_variable:nNn {date, department, institute, author} \l_tmpa_tl {
		\tl_if_empty:cF {beamer@short\l_tmpa_tl} {
			\bool_if:NTF \l_TUDa_tmpa_bool {~|~}
			{\bool_set_true:N \l_TUDa_tmpa_bool}
			\use:c {insertshort\l_tmpa_tl}
		}
	}
	\bool_if:NT \l_TUDa_tmpa_bool {~|~}
	\insertframenumber
	\hfill\raisebox{\dimexpr-.5\height+\dp\strutbox\relax}{\insertlogo}
    \end{beamercolorbox}
}



\RenewDocumentCommand{\logo}{sm}{
	\IfBooleanTF{#1}{
	\setbeamertemplate{logo}{\resizebox{!}{.06\beamer@paperheight}{\mbox{#2}}}%TODO change with aspectratio
	}{
	\setbeamertemplate{logo}{#2}
	}
}

\defbeamertemplate{headline}{TUDa theme.logo} {%
	\begin{beamercolorbox}[
		leftskip=\TUDa@beamer@sep,rightskip=\TUDa@beamer@sep,
		ht=.75\TUDa@beamer@sep,dp=\box_dp:N \TUDa@beamer@headrule_box]{headline}
		\TUDa@beamer@headrule
	\end{beamercolorbox}
}


\box_new:N \l_TUDa_frametitle_box

\defbeamertemplate{frametitle}{TUDa~theme.logo}{%
\nointerlineskip%
\begin{beamercolorbox}[
  sep=\TUDa@beamer@logosep,
  wd=\dimexpr\TUDa@beamer@linewidth+2\TUDa@beamer@extraindent\relax,
  rightskip=\dimexpr-\TUDa@beamer@logosep+\TUDa@beamer@extraindent\relax,
  leftskip=\dimexpr-\TUDa@beamer@logosep+\TUDa@beamer@extraindent\relax,
	]{frametitle}
	\hbox_set:Nn \l_TUDa_frametitle_box {
	\parbox[t]
		{\dimexpr\linewidth- \wd\TUDa@logobox-1em\relax\relax}{%
		\usebeamerfont{frametitle}\strut\insertframetitle
		\ifx\insertframesubtitle\@empty
		\else
		\par
		\usebeamercolor[fg]{framesubtitle}
		\usebeamerfont{framesubtitle}
		\insertframesubtitle
		\fi
	}}
	\leavevmode
	\bool_if:NTF \g_TUDa_centerframetitle_bool
		{\raisebox{\dimexpr-.5\height+.5\depth}}
		{\use:n}
			{\box_use:N \l_TUDa_frametitle_box}
	\hfill%
	\bool_if:NTF \g_TUDa_centerframetitle_bool
		{\raisebox{\dimexpr-.5\height+.5\depth}}
		{\raisebox{\dimexpr-\height+\ht\strutbox}}
		{\usebox\TUDa@logobox}
\end{beamercolorbox}%
\bool_if:NT \g_TUDa_headsepline_bool {
	\nointerlineskip
	\begin{beamercolorbox}[
		sep=\TUDa@beamer@logosep,
		wd=\dimexpr\TUDa@beamer@linewidth+2\TUDa@beamer@extraindent\relax,
		rightskip=-\TUDa@beamer@logosep,
		leftskip=\dimexpr-\TUDa@beamer@logosep+\TUDa@beamer@extraindent\relax,
		ht=\c_TUDa_smallrule_dim,
		dp=0pt
		]{smallrule}
	\end{beamercolorbox}
}
}

\defbeamertemplate*{headline}{TUDa~theme.nologo}
{%
	\vspace{.75\TUDa@beamer@sep}
	\begin{beamercolorbox}[
		leftskip=\TUDa@beamer@sep,rightskip=\TUDa@beamer@sep]{headline}
		\TUDa@beamer@headrule
	\end{beamercolorbox}
      }

\defbeamertemplate*{headline}{TUDa~theme.simple}
{
   		\ifbeamercolorempty[bg]{background~canvas}{
  			\vspace{\dimexpr.5\c_TUDa_logoheight_dim-\c_TUDa_rulesep_dim}
  			\skip_horizontal:n {\beamer@leftmargin}
			\color{identbarcolor}
			\vrule width\dimexpr\textwidth-\beamer@leftmargin-\beamer@rightmargin height\c_TUDa_rulesep_dim
		}{
			\vspace{\dimexpr.5\c_TUDa_logoheight_dim}
		}
}

\defbeamertemplate*{frametitle}{TUDa~theme.nologo}{%
	\nointerlineskip%
\begin{beamercolorbox}[
  sep=\TUDa@beamer@logosep,
  wd=\dimexpr\TUDa@beamer@linewidth+2\TUDa@beamer@extraindent\relax,
  leftskip=\dimexpr-\TUDa@beamer@logosep+\TUDa@beamer@extraindent\relax,
	]{frametitle}
	\hbox_set:Nn \l_TUDa_frametitle_box {
	\parbox[t]
	{\dimexpr\linewidth- \wd\TUDa@logobox-1em\relax\relax}{%
		\usebeamerfont{frametitle}\strut\insertframetitle
		\ifx\insertframesubtitle\@empty
		\else
		\par
		\usebeamercolor[fg]{framesubtitle}
		\usebeamerfont{framesubtitle}
		\insertframesubtitle
		\fi
}}
\leavevmode
\bool_if:NTF \g_TUDa_centerframetitle_bool
{\raisebox{\dimexpr-.5\height+.5\depth}}
{\use:n}
{\box_use:N \l_TUDa_frametitle_box}
%	Rule for voffset similar to logo
	\rule[\dim_eval:n {
		\bool_if:NTF \g_TUDa_centerframetitle_bool
		{-.5\ht\TUDa@logobox+.5\dp\TUDa@logobox} {-\ht\TUDa@logobox+\ht\strutbox}
	}]{0pt}{\dimexpr\ht\TUDa@logobox+\dp\TUDa@logobox\relax}
\end{beamercolorbox}
\bool_if:NT \g_TUDa_headsepline_bool {
	\nointerlineskip
	\begin{beamercolorbox}[
		sep=\TUDa@beamer@logosep,
		wd=\dimexpr\TUDa@beamer@linewidth+2\TUDa@beamer@extraindent\relax,
		rightskip=-\TUDa@beamer@logosep,
		leftskip=\dimexpr-\TUDa@beamer@logosep+\TUDa@beamer@extraindent\relax,
		ht=\c_TUDa_smallrule_dim,
		dp=0pt
		]{smallrule}
	\end{beamercolorbox}
}
}

\cs_new:Nn \TUDa_setup_frame: {
	\bool_if:NTF \g_TUDa_headlinelogo_bool {
		\setbeamertemplate{frametitle}[TUDa~ theme.logo]
		\setbeamertemplate{headline}[TUDa~ theme.logo]
	}{
		\setbeamertemplate{frametitle}[TUDa~ theme.nologo]
		\setbeamertemplate{headline}[TUDa~ theme.nologo]
	}
}
\TUDa_setup_frame:

\newcommand*{\setupTUDaFrame}[1]{
	\keys_set:nn {TUDa/beamer/outer} {#1}
	\TUDa_setup_frame:
}

\ExplSyntaxOff


\mode
<all>

\endinput
